<div class="mermaid">
  {{- .Inner | safeHTML }}
</div>
{{ if not (.Page.Scratch.Get "mermaid") }}
  {{ .Page.Scratch.Set "mermaid" true }}
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script>
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    mermaid.initialize({
      startOnLoad: true,
      theme: 'base',
      securityLevel: 'loose',
      themeVariables: isDark ? {
        primaryColor: '#1e3a5f',
        primaryTextColor: '#e0e0e0',
        primaryBorderColor: '#4fc3f7',
        lineColor: '#607d8b',
        secondaryColor: '#2e3b4e',
        tertiaryColor: '#1b3320',
        background: '#1a1a2e',
        mainBkg: '#1e3a5f',
        nodeBorder: '#4fc3f7',
        clusterBkg: '#16213e',
        clusterBorder: '#37474f',
        titleColor: '#e0e0e0',
        edgeLabelBackground: '#1a1a2e',
        fontFamily: 'Inter, system-ui, -apple-system, sans-serif',
        fontSize: '14px',
      } : {
        primaryColor: '#e3f2fd',
        primaryTextColor: '#1a237e',
        primaryBorderColor: '#1565c0',
        lineColor: '#78909c',
        secondaryColor: '#fff3e0',
        tertiaryColor: '#e8f5e9',
        background: '#ffffff',
        mainBkg: '#e3f2fd',
        nodeBorder: '#1565c0',
        clusterBkg: '#f5f5f5',
        clusterBorder: '#bdbdbd',
        titleColor: '#212121',
        edgeLabelBackground: '#ffffff',
        fontFamily: 'Inter, system-ui, -apple-system, sans-serif',
        fontSize: '14px',
      },
      flowchart: {
        curve: 'basis',
        padding: 20,
        htmlLabels: true,
        nodeSpacing: 50,
        rankSpacing: 60,
        useMaxWidth: true,
      },
    });
  </script>
{{ end }}
